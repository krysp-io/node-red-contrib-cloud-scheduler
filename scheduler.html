<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="Scheduler">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span> Name</span></label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-account"><i class="fa fa-user"></i> Credentials</label>
        <input type="text" id="node-input-account">
    </div>
    
    <div class="form-row">
        <label for="node-input-method"><i class="fa fa-tasks"></i> <span> Method</span></label>
        <select type="text" id="node-input-method" style="width:70%;" value="post">
            <option value="post">POST</option>
            <option value="put">PUT</option>
            <option value="patch">PATCH</option>
        </select>
    </div>
    
    <div class="form-row">
        <label for="node-input-url"><i class="fa fa-tag"></i> <span> URL</span></label>
        <input type="text" id="node-input-url" value="url">
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-not_publicly_accessible" class="node-red-accessible" style="display:inline-block; width:15px; vertical-align:baseline; margin-left: 100px;">
        <label for="node-input-not_publicly_accessible" style="display: inline;width: 100%;"> This URL is accessible from the internet. <a href="#" id="node-red-help">Help</a></label>
    </div>
    
    <div class="d-flex justify-content-center" id="node-once">
        <label for="node-input-once">&nbsp;</label>
        <span>inject once after</span>&nbsp;
        <input type="text" id="node-input-onceDelay" placeholder="0.1" style="width:45px; height:28px;">&nbsp;
        <span>seconds, then</span>
    </div>

    <div class="form-row">
        <label for=""><i class="fa fa-repeat"></i> <span> Repeat</span></label>
        <select id="inject-time-type-select" class="form-control">
            <option value="interval">interval</option>
            <option value="interval-time">interval between times</option>
            <option value="time">at a specific time</option>
        </select>
        <input type="hidden" id="node-input-repeat">
        <input type="hidden" id="node-input-crontab">
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-interval">
        <span data-i18n="inject.every">every </span>
        <input id="inject-time-interval-count" class="inject-time-count" value="1"></input>
        <select style="width:100px" id="inject-time-interval-units">
            <option value="m">minutes</option>
            <option value="h">hours</option>
        </select><br/>
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-interval-time">
        <span>every </span> <select style="width:90px; margin-left:20px;" id="inject-time-interval-time-units" class="inject-time-int-count" value="1">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="10">10</option>
            <option value="12">12</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="0">60</option>
        </select> <span> minutes </span><br/>
        <span> between </span> <select id="inject-time-interval-time-start" class="inject-time-times"></select>
        <span> and </span> <select id="inject-time-interval-time-end" class="inject-time-times"></select><br/>
        <div id="inject-time-interval-time-days" class="inject-time-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;"> on</div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span>Monday</span></label>
                    <label><input type='checkbox' checked value='2'/> <span>Tuesday</span></label>
                    <label><input type='checkbox' checked value='3'/> <span>Wednedsay</span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span>Thursday</span></label>
                    <label><input type='checkbox' checked value='5'/> <span>Friday</span></label>
                    <label><input type='checkbox' checked value='6'/> <span>Saturday</span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span>Sunday</span></label>
                </div>
            </div>
        </div>
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-time">
        <span>at</span> <input type="text" id="inject-time-time" value="12:00"></input><br/>
        <div id="inject-time-time-days" class="inject-time-days">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;">on</div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span>Monday</span></label>
                    <label><input type='checkbox' checked value='2'/> <span>Tuesday</span></label>
                    <label><input type='checkbox' checked value='3'/> <span>Wednedsay</span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span>Thursday</span></label>
                    <label><input type='checkbox' checked value='5'/> <span>Friday</span></label>
                    <label><input type='checkbox' checked value='6'/> <span>Saturday</span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span>Sunday</span></label>
                </div>
            </div>
        </div>
    </div>

</script>

<script type="text/html" data-help-name="Scheduler">
    <p>Connects to <a href="https://cloud.google.com/scheduler/docs/" target="_blank">Google Cloud Scheduler</a> and schedules a job.</p>
    <h3>Pre-requisites</h3>
    <p>Google Cloud Scheduler requires the URL to be accessible for triggering the scheduled task.</p>
 
    <p>For this task to be invoked by cloud scheduler,the URL must be:</p>
        <p>1. URL must be accessible from the internet.</p>
        <p>2. Localhost or 127.0.0.1 will not work.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>Credentials <span class="property-type">string</span></dt>
        <dd>Google Cloud Credentials that will be configured in the node.</dd>
        <dt>Method <span class="property-type">string</span></dt>
        <dd>HTTP method that will be configured in the node.If not supplied, POST will be used.</dd>
        <dt>URL <span class="property-type">string</span></dt>
        <dd>Publicly accessible URL that will be configured in the node for creating HTTP in node.</dd>
        <dt>Repeat <span class="property-type">string</span></dt>
        <dd>Time interval on which task should be executed.</dd>
    </dl>
    <h3>Details</h3>
    <p>This node triggers the flow that has been scheduled to a job.</p>

    <p>For more information navigate to <a href="https://github.com/krysp-io/node-red-contrib-scheduler">Github Documentation</a></p>
    
    <p><b>Note:</b>The flow must include an HTTP Response node.</p>
    

</script>

<style>
    input[type="checkbox"]:focus {
        border-color: #ffffcc;
        background: #ffffcc;
        outline:5px solid #ffffcc;
    }

    .form-row {
        display: block;
        margin-right: -5px;
        margin-left: -5px;
    }

    .inject-time-row {
        padding-left: 110px;
    }

    .inject-time-row select {
        margin: 3px 0;
    }

    .inject-time-days label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: baseline;
        width: 100px;
    }

    .inject-time-days input {
        width: auto !important;
        vertical-align: baseline !important;
    }

    .inject-time-times {
        width: 90px !important;
    }

    #inject-time-time {
        width: 75px;
        margin-left: 8px;
        margin-bottom: 8px;
    }

    .inject-time-count {
        width: 40px !important;
    }
</style>

<script type="text/javascript">
    (function () {

        function resizeDialog(size) {
            size = size || { height: $(".red-ui-tray-content form").height() }
            var rows = $("#dialog-form>div:not(.node-input-property-container-row):visible");
            var height = size.height;
            for (var i = 0; i < rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-property-container-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
            height += 16;
            $("#node-input-property-container").editableList('height', height);
        }
        /** Perform inject, optionally sending a custom msg (refactored for re-use in the form inject button)*/
        function doInject(node, customMsg) {
            // var label = node._def.label.call(node,customMsg?customMsg.__user_inject_props__:undefined);
            // if (label.length > 30) {
            //     label = label.substring(0, 50) + "...";
            // }
            // label = label.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            $.ajax({
                url: "inject/" + node.id,
                type: "POST",
                data: JSON.stringify({}),
                contentType: "application/json; charset=utf-8",
                success: function (resp) {
                    RED.notify(node._("inject.success", { label: label }), { type: "success", id: "inject", timeout: 2000 });
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    if (jqXHR.status == 404) {
                        RED.notify("<strong>Error</strong>:node not deployed", "error");
                    } else if (jqXHR.status == 500) {
                        RED.notify("<strong>Error</strong>:inject failed, see log for details", "error");
                    } else if (jqXHR.status == 0) {
                        RED.notify("<strong>Error</strong>:no response from server", "error");
                    } else {
                        RED.notify("<strong>Error</strong>:unexpected error", "error");
                    }
                }
            });
        }
        RED.nodes.registerType('Scheduler', {
            category: 'krysp',
            color: "#a6bbcf",
            defaults: {
                name: { value: "Scheduler", required: true },
                account: { type: "google-cloud-credentials", required: true },
                props: {},
                repeat: { value: "", validate: function (v) { return ((v === "") || (RED.validators.number(v) && (v >= 0) && (v <= 2147483))) } },
                crontab: { value: "" },
                once: { value: true },
                onceDelay: { value: 0.1 },
                url: { value: `${window.location.origin}/Scheduler`, required: true, validate: function (v) { var pattern = /localhost|127.0.0.1/gi; return !pattern.test(v) } },
                method: { value: "post" },
                not_publicly_accessible: { value: false, required: true, validate: function (v) { return $("#node-input-not_publicly_accessible").prop("checked") } }
            },
            icon: "inject.svg",
            inputs: 0,
            outputs: 1,
            label: function (customProps) {
                var suffix = "";
                // if fire once then add small indication
                if (this.once) {
                    suffix = " ยน";
                }
                // but replace with repeat one if set to repeat
                if ((this.repeat && this.repeat != 0) || this.crontab) {
                    suffix = " โป";
                }
                if (this.name) {
                    return this.name + suffix;
                }
                return this._("inject.inject") + suffix;
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function () {
                var node = this;

                $("#node-red-help").on("click", function (e) {
                    e.preventDefault();
                    RED.sidebar.help.show("Scheduler");
                })

                $("#node-input-name").change(function () {
                    this.url = `${window.location.origin}/${$("#node-input-name").val()}`;
                    $("#node-input-url").val(this.url)
                })


                $("#inject-time-type-select").on("change", function () {
                    $("#node-input-crontab").val('');
                    var id = $("#inject-time-type-select").val();
                    $(".inject-time-row").hide();
                    $("#inject-time-row-" + id).show();
                    if ((id == "none") || (id == "interval") || (id == "interval-time")) {
                        $("#node-once").show();
                        $("#node-input-once").prop('checked', true);
                    }
                    else {
                        $("#node-once").hide();
                        $("#node-input-once").prop('checked', false);
                    }

                    // Scroll down
                    var scrollDiv = $("#dialog-form").parent();
                    scrollDiv.scrollTop(scrollDiv.prop('scrollHeight'));
                    resizeDialog();
                });

                $("#node-input-once").on("change", function () {
                    $("#node-input-onceDelay").attr('disabled', !$("#node-input-once").prop('checked'));
                })

                $(".inject-time-times").each(function () {
                    for (var i = 0; i < 24; i++) {
                        var l = (i < 10 ? "0" : "") + i + ":00";
                        $(this).append($("<option></option>").val(i).text(l));
                    }
                });
                $("<option></option>").val(24).text("00:00").appendTo("#inject-time-interval-time-end");
                $("#inject-time-interval-time-start").on("change", function () {
                    var start = Number($("#inject-time-interval-time-start").val());
                    var end = Number($("#inject-time-interval-time-end").val());
                    $("#inject-time-interval-time-end option").remove();
                    for (var i = start + 1; i < 25; i++) {
                        var l = (i < 10 ? "0" : "") + i + ":00";
                        if (i == 24) {
                            l = "00:00";
                        }
                        var opt = $("<option></option>").val(i).text(l).appendTo("#inject-time-interval-time-end");
                        if (i === end) {
                            opt.attr("selected", "selected");
                        }
                    }
                });

                $(".inject-time-count").spinner({
                    //max:60,
                    min: 1
                });

                var repeattype = "time";
                if (node.crontab) {
                    var cronparts = node.crontab.split(" ");
                    var days = cronparts[4];
                    var minutesPart = cronparts[0].split("/");
                    var hoursPart = cronparts[1].split("/");
                    if (!isNaN(cronparts[0]) && !isNaN(cronparts[1])) {
                        repeattype = "time";
                        // Fixed time
                        var time = cronparts[1] + ":" + cronparts[0];
                        $("#inject-time-time").val(time);
                        $("#inject-time-type-select").val("s");
                        if (days == "*") {
                            $("#inject-time-time-days input[type=checkbox]").prop("checked", true);
                        } else {
                            $("#inject-time-time-days input[type=checkbox]").removeAttr("checked");
                            days.split(",").forEach(function (v) {
                                $("#inject-time-time-days [value=" + v + "]").prop("checked", true);
                            });
                        }
                    } else {
                        repeattype = "interval-time";
                        // interval - time period
                        var minutes = cronparts[0].slice(2);
                        if (minutes === "") { minutes = "0"; }
                        $("#inject-time-interval-time-units").val(minutes);
                        if (days == "*") {
                            $("#inject-time-interval-time-days input[type=checkbox]").prop("checked", true);
                        } else {
                            $("#inject-time-interval-time-days input[type=checkbox]").removeAttr("checked");
                            days.split(",").forEach(function (v) {
                                $("#inject-time-interval-time-days [value=" + v + "]").prop("checked", true);
                            });
                        }
                        var time = cronparts[1];
                        var timeparts = time.split(",");
                        var start;
                        var end;
                        if (timeparts.length == 1) {
                            // 0 or 0-10
                            var hours = timeparts[0].split("-");
                            if (hours.length == 1) {
                                if (hours[0] === "") {
                                    start = "0";
                                    end = "0";
                                }
                                else {
                                    start = hours[0];
                                    end = Number(hours[0]) + 1;
                                }
                            } else {
                                start = hours[0];
                                end = Number(hours[1]) + 1;
                            }
                        } else {
                            // 23,0 or 17-23,0-10 or 23,0-2 or 17-23,0
                            var startparts = timeparts[0].split("-");
                            start = startparts[0];

                            var endparts = timeparts[1].split("-");
                            if (endparts.length == 1) {
                                end = Number(endparts[0]) + 1;
                            } else {
                                end = Number(endparts[1]) + 1;
                            }
                        }
                        $("#inject-time-interval-time-end").val(end);
                        $("#inject-time-interval-time-start").val(start);

                    }
                } else {
                    $("#inject-time-type-select").val("none");
                }

                $(".inject-time-row").hide();
                $("#inject-time-type-select").val(repeattype);
                $("#inject-time-row-" + repeattype).show();

                /* */

                var eList = $('#node-input-property-container').css('min-height', '120px').css('min-width', '450px');

                eList.editableList({
                    buttons: [
                        {
                            id: "node-inject-test-inject-button",
                            label: node._("inject.injectNow"),
                            click: function (e) {
                                doInject(node);
                            }
                        }
                    ],
                    removable: true,
                    sortable: true
                });
                $('#node-inject-test-inject-button').css("float", "right").css("margin-right", "unset");

                if (RED.nodes.subflow(node.z)) {
                    $('#node-inject-test-inject-button').attr("disabled", true);
                }



                $("#inject-time-type-select").trigger("change");
                $("#inject-time-interval-time-start").trigger("change");

            },
            oneditsave: function () {
                var repeat = "";
                var crontab = "";
                var type = $("#inject-time-type-select").val();
                if (type == "none") {
                    // nothing
                } else if (type == "interval") {
                    var count = $("#inject-time-interval-count").val();
                    var units = $("#inject-time-interval-units").val();
                    if (units == "m") {
                        crontab = "*/" + count + " * * * *";
                        // repeat = count * 60;
                    } else if (units == "h") {
                        crontab = "0 */" + count + " * * *";
                        // repeat = count * 60 * 60;
                    }
                } else if (type == "interval-time") {
                    repeat = "";
                    var count = $("#inject-time-interval-time-units").val();
                    var startTime = Number($("#inject-time-interval-time-start").val());
                    var endTime = Number($("#inject-time-interval-time-end").val());
                    var days = $('#inject-time-interval-time-days input[type=checkbox]:checked').map(function (_, el) {
                        return $(el).val()
                    }).get();
                    if (days.length == 0) {
                        crontab = "";
                    } else {
                        if (days.length == 7) {
                            days = "*";
                        } else {
                            days = days.join(",");
                        }
                        var timerange = "";
                        if (endTime == 0) {
                            timerange = startTime + "-23";
                        } else if (startTime + 1 < endTime) {
                            timerange = startTime + "-" + (endTime - 1);
                        } else if (startTime + 1 == endTime) {
                            timerange = startTime;
                        } else {
                            var startpart = "";
                            var endpart = "";
                            if (startTime == 23) {
                                startpart = "23";
                            } else {
                                startpart = startTime + "-23";
                            }
                            if (endTime == 1) {
                                endpart = "0";
                            } else {
                                endpart = "0-" + (endTime - 1);
                            }
                            timerange = startpart + "," + endpart;
                        }
                        if (count === "0") {
                            crontab = count + " " + timerange + " * * " + days;
                        } else {
                            crontab = "*/" + count + " " + timerange + " * * " + days;
                        }
                    }
                } else if (type == "time") {
                    var time = $("#inject-time-time").val();
                    var days = $('#inject-time-time-days  input[type=checkbox]:checked').map(function (_, el) {
                        return $(el).val()
                    }).get();
                    if (days.length == 0) {
                        crontab = "";
                    } else {
                        if (days.length == 7) {
                            days = "*";
                        } else {
                            days = days.join(",");
                        }
                        var parts = time.split(":");
                        if (parts.length === 2) {
                            repeat = "";
                            parts[1] = ("00" + (parseInt(parts[1]) % 60)).substr(-2);
                            parts[0] = ("00" + (parseInt(parts[0]) % 24)).substr(-2);
                            crontab = parts[1] + " " + parts[0] + " * * " + days;
                        }
                        else { crontab = ""; }
                    }
                }

                $("#node-input-repeat").val(repeat);
                $("#node-input-crontab").val(crontab)
            },
            button: {
                enabled: function () {
                    return !this.changed
                },
                onclick: function () {
                    if (this.changed) {
                        return RED.notify(RED._("notification.warning", { message: RED._("notification.warnings.undeployedChanges") }), "warning");
                    }
                    doInject(this);
                }
            },
            oneditresize: resizeDialog
        });
    })();
</script>